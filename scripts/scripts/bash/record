#!/bin/bash

set -e

if ! command -v agg >/dev/null 2>&1; then
  echo "Error: agg is required but not installed."
  echo "Install with: brew install agg"
  exit 1
fi

if ! command -v ffmpeg >/dev/null 2>&1; then
  echo "Error: ffmpeg is required but not installed."
  echo "Install with: brew install ffmpeg"
  exit 1
fi

TEMP_FILE=$(mktemp -t asciinema).cast
TEMP_GIF="${TEMP_FILE%.cast}.gif"
OUTPUT_FILE="${TEMP_FILE%.cast}.mp4"

echo "Starting asciinema recording..."
echo "Press Ctrl+D or type 'exit' when done recording."
echo ""

asciinema rec "$TEMP_FILE"

echo ""
echo "Recording saved to: $TEMP_FILE"
echo "Converting to GIF..."

agg --font-family "JetBrainsMono Nerd Font" "$TEMP_FILE" "$TEMP_GIF"

echo "Converting to MP4..."
if ffmpeg -i "$TEMP_GIF" -vf "scale=trunc(iw/2)*2:trunc(ih/2)*2" -c:v libx264 -preset slow -crf 28 -movflags +faststart -pix_fmt yuv420p "$OUTPUT_FILE" -y >/dev/null 2>&1; then
  rm "$TEMP_GIF"
  echo "Converted to MP4"
else
  echo "Conversion failed!"
  exit 1
fi

echo "Opening file location in Finder..."
open -R "$OUTPUT_FILE"

echo ""
echo "File ready at: $OUTPUT_FILE"
echo "You can now drag this file into GitHub."
